
DELIMITER //
CREATE OR REPLACE PROCEDURE GetAllowedCourses(IN iSchoolID varchar(10), OUT oCoursesID VARCHAR(2000))

BEGIN
DECLARE v_finished INTEGER DEFAULT 0;
DECLARE v_pre_req varchar(200) DEFAULT "";

-- declare cursor
 DECLARE prerequisites_cursor CURSOR FOR SELECT CORE FROM prerequisites WHERE SCHOOL_ID = iSchoolID
 AND REQ = 'COURSE_PREREQUISITES';
 
 -- declare NOT FOUND handler
 DECLARE CONTINUE HANDLER 
        FOR NOT FOUND SET v_finished = 1;

OPEN prerequisites_cursor;


get_pre_req: LOOP
 
 FETCH prerequisites_cursor  INTO v_pre_req;
 
 IF v_finished = 1 THEN 
 LEAVE get_pre_req;
 END IF;
 
 -- build pre-req list
 SET oCoursesID =  CONCAT(v_pre_req,";",oCoursesID);
 
 END LOOP get_pre_req;
 
 CLOSE prerequisites_cursor;

 END //
DELIMITER ;

SET @oCoursesID = "";
SET @iSchoolID = '323';
SET @iCourses = '3620C';
CALL GetAllowedCourses(@iSchoolID,@iCourses,@oCoursesID);
SELECT @oCoursesID;

SELECT concat(COURSE , ifnull(GRADE_REQUIRED,'NA'))  FROM prerequisites WHERE concat(COURSE , ifnull(GRADE_REQUIRED,'NA'))  IN ('3620C')
 AND SCHOOL_ID = 323
 AND REQ = 'COURSE_PREREQUISITES'
 
 
 SET @oCoursesID = "";
CALL GetAllowedCourses('323','3620C',@oCoursesID);
SELECT @oCoursesID;

 SET @oCoursesID = "";
CALL GetAllowedCourses('323',@oCoursesID);
SELECT @oCoursesID;